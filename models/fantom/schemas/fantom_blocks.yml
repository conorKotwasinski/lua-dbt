version: 2

models:
  - name: fantom_blocks
    config:
      alias: blocks
    description: "Blocks are batches of transactions with a hash of the previous block in the chain."
    meta:
      url: https://ethereum.org/en/developers/docs/blocks/
    columns:
      - name: number
        description: "The length of the blockchain (count of blocks)"
        tests:
          - not_null
          - unique:
              config:
                where: "timestamp between (today() - 5) and date_sub(hour, 2, now())"
        meta:
          explore:
            title: "Blocks"
            type: "bigNumber"
            subheader: "Mining {{past_30_days}} per day (last 30 days)"
            formats:
              past_30_days: '#,##0'
              total: '#,##0.0,,"M"'
            sql: |
              select 
              count(1) as "total",
              sum(case when b.timestamp >= subtractDays(today(), 30) then 1 else 0 end) / 30 as past_30_days,
              min("number") as "min",
              max("number") as "max"
              from fantom.blocks as b

      - name: hash
        description: "A unique identifier for the block"
        tests:
          - not_null
          - unique:
              config:
                where: "timestamp between (today() - 5) and date_sub(hour, 2, now())"

      - name: parent_hash
        description: The hash of the parent (prior) block
        tests:
          - not_null
          - unique:
              config:
                where: "timestamp between (today() - 5) and date_sub(hour, 2, now())"

      - name: timestamp
        description: The timestamp when the block was mined (UTC)
        meta:
          # name the clickhouse columns something that makes sense to echarts, e.g. xAxis
          explore:
            title: "Blocks by day"
            sql: |
              select 
              toDate(toDateTime(t.timestamp)) as "xAxis",
              count(1) as "series_0"
              from fantom.blocks as t 
              where timestamp > 0
              group by "xAxis"
              order by "xAxis" asc

      - name: size
        description: "Size of block in bytes"
      - name: transaction_count
        description: "# of transactions in the block"
        meta:
          explore:
            title: "Transactions by day"
            sql: |
              select 
              toDate(toDateTime(t.timestamp)) as "xAxis",
              sum(transaction_count) as "series_0"
              from fantom.blocks as t 
              where timestamp > 0
              group by "xAxis"
              order by "xAxis" asc

      - name: transactions_root
        description: "The root hash of the Merkle tree of all the transactions in the block (32 byte string)"

      - name: miner
        description: "The address of the miner who mined the block"

      - name: nonce
        description: "The nonce used to mine the block"

      - name: logs_bloom
        description: "The bloom filter for the logs in the block"

      - name: state_root
        description: "The root of the state trie at the end of the block"

      - name: difficulty
        description: "The effort required to mine the block"

      - name: total_difficulty
        description: "Cumulative difficulty of all blocks until the current block"

      - name: sha3_uncles
        description: "A sibling block of the parent block"

      - name: receipts_root
        description: "The hash of the root node of the trie that contains the receipts of all transactions listed in this block."

      - name: size
        description: Block size

      - name: gas_used
        description: "The amount of gas used by the block"
        meta:
          explore:
            title: "Gas by day"
            sql: |
              select 
              toDate(toDateTime(t.timestamp)) as "xAxis",
              sum(gas_used) as "series_0"
              from fantom.blocks as t 
              where timestamp > 0
              group by "xAxis"
              order by "xAxis" asc

      - name: gas_limit
        description: "The gas limit allowed in the block"

      - name: base_fee_per_gas
        description: "The base fee for this block (see EIP-1559)"

      - name: extra_data
        description: "An optional 32-byte space to store extra data"
